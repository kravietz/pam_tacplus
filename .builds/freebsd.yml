# build manifest for SourceHut
# https://man.sr.ht/builds.sr.ht/
image: freebsd/latest
packages:
- autoconf
- libtool
- automake
- tacacs
- expect
- pamtester
- gcc
sources:
- https://git.sr.ht/~kravietz/pam-tacplus
tasks:
- configure: |
        cd pam-tacplus
        autoreconf -i
        ./configure
        make
- setup-test: |
        cd pam-tacplus
        sudo make install
        sudo ldconfig
        echo testuser1::::::::/bin/sh:testpass123 | sudo adduser -w yes -f -
        sudo install -o root test/freebsd/pam.conf /etc/pam.d/test
        sudo install -o root test/freebsd/tac_plus.conf /usr/local/etc/tac_plus.conf
        echo 'tac_plus_enable="YES"' | sudo tee -a /etc/rc.conf.local
        sudo service tac_plus start && sleep 3
- functional-test-tacc: |
        /usr/local/bin/tacc --authenticate --authorize --account --username testuser1 --password testpass123 --server localhost --remote 5.6.7.8 --tty ttyS0 --secret testkey123 --service ppp --protocol ip --login pap
        /usr/local/bin/tacc --authenticate --authorize --account --username testuser2 --password testpass123 --server localhost --remote 5.6.7.8 --tty ttyS0 --secret testkey123 --service ppp --protocol ip --login pap
        /usr/local/bin/tacc --authenticate --authorize --account --username testuser1 --password badpass --server localhost --remote 5.6.7.8 --tty ttyS0 --secret testkey123 --service ppp --protocol ip --login pap || true
        /usr/local/bin/tacc --authenticate --authorize --account --username testuser1 --password testpass123 --server localhost --remote 5.6.7.8 --tty ttyS0 --secret badkey --service ppp --protocol ip --login pap || true
- functional-test-expect: |
        cd pam-tacplus
        ./configure
        make clean all
        sudo make install
        expect test/freebsd/test1.expect
        expect test/freebsd/test2.expect
- asan-test-tacc-gcc: |
        cd pam-tacplus
        make clean
        env CC=gcc ./configure --enable-asan
        make clean all
        export ASAN_OPTIONS=abort_on_error=1:fast_unwind_on_malloc=0
        ./tacc --authenticate --username testuser1 --password testpass123 --server localhost --remote 5.6.7.8 --tty ttyS0 --secret testkey123 --service ppp --protocol ip --login pap
        ./tacc --authorize --username testuser1 --password testpass123 --server localhost --remote 5.6.7.8 --tty ttyS0 --secret testkey123 --service ppp --protocol ip --login pap
        ./tacc --account --username testuser1 --password testpass123 --server localhost --remote 5.6.7.8 --tty ttyS0 --secret testkey123 --service ppp --protocol ip --login pap
        ./tacc --authenticate --username testuser1 --password badpass --server localhost --remote 5.6.7.8 --tty ttyS0 --secret testkey123 --service ppp --protocol ip --login pap || true
        ./tacc --authorize --username testuser1 --password badpass --server localhost --remote 5.6.7.8 --tty ttyS0 --secret testkey123 --service ppp --protocol ip --login pap || true
        ./tacc --account --username testuser1 --password badpass --server localhost --remote 5.6.7.8 --tty ttyS0 --secret testkey123 --service ppp --protocol ip --login pap || true
        ./tacc --authenticate --username testuser1 --password testpass123 --server localhost --remote 5.6.7.8 --tty ttyS0 --secret badkey --service ppp --protocol ip --login pap || true
        ./tacc --authenticate --authorize --account --username testuser1 --password testpass123 --server localhost --remote 5.6.7.8 --tty ttyS0 --secret testkey123 --service ppp --protocol ip --login pap
- asan-test-tacc-clang: |
        cd pam-tacplus
        make clean
        ./configure --enable-asan
        make clean all
        export ASAN_OPTIONS=abort_on_error=1:fast_unwind_on_malloc=0:detect_leaks=1
        ./tacc --authenticate --username testuser1 --password testpass123 --server localhost --remote 5.6.7.8 --tty ttyS0 --secret testkey123 --service ppp --protocol ip --login pap
        ./tacc --authorize --username testuser1 --password testpass123 --server localhost --remote 5.6.7.8 --tty ttyS0 --secret testkey123 --service ppp --protocol ip --login pap
        ./tacc --account --username testuser1 --password testpass123 --server localhost --remote 5.6.7.8 --tty ttyS0 --secret testkey123 --service ppp --protocol ip --login pap
        ./tacc --authenticate --username testuser1 --password badpass --server localhost --remote 5.6.7.8 --tty ttyS0 --secret testkey123 --service ppp --protocol ip --login pap || true
        ./tacc --authorize --username testuser1 --password badpass --server localhost --remote 5.6.7.8 --tty ttyS0 --secret testkey123 --service ppp --protocol ip --login pap || true
        ./tacc --account --username testuser1 --password badpass --server localhost --remote 5.6.7.8 --tty ttyS0 --secret testkey123 --service ppp --protocol ip --login pap || true
        ./tacc --authenticate --username testuser1 --password testpass123 --server localhost --remote 5.6.7.8 --tty ttyS0 --secret badkey --service ppp --protocol ip --login pap || true
        ./tacc --authenticate --authorize --account --username testuser1 --password testpass123 --server localhost --remote 5.6.7.8 --tty ttyS0 --secret testkey123 --service ppp --protocol ip --login pap            
