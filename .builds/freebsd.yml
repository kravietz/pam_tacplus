# build manifest for SourceHut
# https://man.sr.ht/builds.sr.ht/
image: freebsd/latest
packages:
- autoconf
- libtool
- automake
- tacacs
- expect
- pamtester
# for scan-build
- llvm
- gnulib
# -fsanitize=address on FreeBSD is only supported on GCC >= 11
- gcc11-devel
sources:
- https://git.sr.ht/~kravietz/pam-tacplus
tasks:
- gnulib: |
          cd pam-tacplus
          # autoconf may fail on systems with older gnulib, in such case we patch up and re-run
          autoreconf -f -i -v || gnulib-tool --libtool --update && autoreconf -f -i -v
- build-cc: |
        cd pam-tacplus
        ./configure
        make clean all
- setup: |
        cd pam-tacplus
        sudo make install
        sudo ldconfig
        sudo install -o root test/freebsd/pam.conf /etc/pam.d/test
        sudo install -o root test/freebsd/tac_plus.conf /usr/local/etc/tac_plus.conf
        echo 'tac_plus_enable="YES"' | sudo tee -a /etc/rc.conf.local
        sudo service tac_plus start && sleep 3
        # not really necessary, users statically defined in pam_tac.conf
        #echo testuser1::::::::/bin/sh:testpass123 | sudo adduser -w yes -f -        
- functional-test-tacc: |
        cd pam-tacplus
        sh -x test/tacc.sh
- functional-test-pam: |  
        cd pam-tacplus
        expect test/freebsd/tests.expect      
        
