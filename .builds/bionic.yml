# build manifest for SourceHut
# https://man.sr.ht/builds.sr.ht/
# use bionic as it's the last distribution to include tacacs+ package
image: ubuntu/bionic
packages:
- autoconf
- build-essential
- libtool
- automake
- libpam-dev
- libssl-dev
- tacacs+
- ca-certificates
- expect
- pamtester
- clang
- clang-tools
- gnulib
sources:
- https://git.sr.ht/~kravietz/pam-tacplus
tasks:
- setup-bionic: |
        cd pam-tacplus
        sudo install -o root test/bionic/pam.conf /etc/pam.d/test
        sudo install -o root test/bionic/tac_plus.conf /etc/tacacs+/tac_plus.conf
        sudo service tacacs_plus restart && sleep 3
        # not really necessary, users statically defined in pam_tac.conf
        #sudo useradd -m testuser1
        #echo testuser1:testpass123 | sudo chpasswd -c SHA512
- gnulib: |
        cd pam-tacplus
        gnulib-tool --makefile-name=Makefile.gnulib --libtool --symlink --import \
                fcntl crypto/md5 array-list list xlist getrandom realloc explicit_bzero xalloc
        autoreconf -f -i -v
- build-cc: |
        cd pam-tacplus
        ./configure
        make clean all
- functional-test-tacc: |
        cd pam-tacplus
        sh -x test/tacc.sh
- functional-test-pam: |  
        cd pam-tacplus
        expect test/bionic/tests.expect
# - scan-build-clang: |
#         cd pam-tacplus
#         gnulib-tool --import  fcntl crypto/md5 array-list list xlist getrandom realloc
#         autoreconf -f -i -v
#         # required for pam_tacplus.so testing with ASAN, only works with clang
#         export LDFLAGS=-shared-libasan
#         scan-build --use-cc=clang ./configure #--enable-asan
#         scan-build --use-cc=clang make clean all
#         sudo make install
#         sudo ldconfig
# - scan-build-gcc: |
#         # only compilation test
#         cd pam-tacplus
#         autoreconf -i
#         scan-build --use-cc=gcc ./configure --enable-asan
#         scan-build --use-cc=gcc make clean all
# - functional-test-tacc-asan: |
#         cd pam-tacplus
#         # increases ASAN leak detector precision and coverage
#         #export ASAN_OPTIONS=abort_on_error=1:fast_unwind_on_malloc=0:detect_leaks=1
#         #export LD_PRELOAD=$(clang -print-file-name=libclang_rt.asan-x86_64.so)
#         sh -x test/tacc.sh
# - functional-test-pam-asan: |  
#         cd pam-tacplus
#         #export ASAN_OPTIONS=abort_on_error=1:fast_unwind_on_malloc=0:detect_leaks=1
#         # required for pam_tacplus.so testing with ASAN, only works with clang
#         #export LD_PRELOAD=$(clang -print-file-name=libclang_rt.asan-x86_64.so)
#         expect test/bionic/tests.expect